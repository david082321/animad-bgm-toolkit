<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8">
  <title>BGM TV 轉跳器</title>
</head>

<body>
  <h1>BGM TV 轉跳器</h1>
  <p>正在處理請稍候...</p>

  <script>
    // 取得 URL 參數 bgmId
    const urlParams = new URLSearchParams(window.location.search);
    const bgmIdParam = urlParams.get('id');
    const nameParam = urlParams.get('name');

    if (!bgmIdParam) {
      document.body.innerHTML = '<p>請傳入 id 參數，例如 https://animad-bgm-toolkit.pages.dev/?id=114514</p><br/><p>使用方法請前往 <a href="https://github.com/david082321/animad-bgm-toolkit">https://github.com/david082321/animad-bgm-toolkit</a> 查看。</p>';
      throw new Error('bgmId not provided');
    }

    // 讀取 JSON
    fetch('/animeData.json')
      .then(res => {
        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        return res.json();
      })
      .then(data => {
        const bgmIdNumber = parseInt(bgmIdParam);

        // 透過搜尋 bgmId 來找到對應的 "標題名稱" (key)
        // 可能存在多層結構
        const titleEntry = Object.entries(data).find(([title, info]) => {
          if (info.parts) {
            return info.parts.some(p => p.bgmId === bgmIdNumber);
          }
          return info.bgmId === bgmIdNumber;
        });

        if (!titleEntry) {
          if (nameParam) {
            const encodedTitle = encodeURIComponent(nameParam);
            window.location.href = `https://ani.gamer.com.tw/search.php?keyword=${encodedTitle}`;
          }
          console.error('在 JSON 資料中找不到對應的項目。');
          document.body.innerHTML = '<p>找不到對應動畫</p>';
          return;
        }

        // 透過 title 取得對應的項目資料
        const [title, info] = titleEntry;
        let item = info.parts
          ? info.parts.find(p => p.bgmId === bgmIdNumber)
          : info;

        console.log(`成功找到項目: "${title}"`, item);

        // 優先跳 aniId
        if (item.aniId) {
          window.location.href = `https://ani.gamer.com.tw/animeVideo.php?sn=${item.aniId}`;
        }
        // 再跳 acgId
        else if (item.acgId) {
          window.location.href = `https://acg.gamer.com.tw/acgDetail.php?s=${item.acgId}`;
        }
        // 都沒有，跳到搜尋頁面
        else {
          // 使用 encodeURIComponent 來確保標題中的特殊字元 (如空格) 能在 URL 中正確傳遞
          const encodedTitle = encodeURIComponent(title);
          window.location.href = `https://ani.gamer.com.tw/search.php?keyword=${encodedTitle}`;
        }
      })
      .catch(err => {
        console.error('讀取或處理 JSON 時發生錯誤:', err);
        document.body.innerHTML = '<p>載入 animeData.json 失敗</p>';
      });
  </script>
</body>

</html>
